name: Build and Release

on:
  push:
    tags:
      - 'v*' # Run workflow on version tags, e.g. v1.0.0

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.20'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64 upx-ucl libgl1-mesa-dev xorg-dev
          go install fyne.io/fyne/v2/cmd/fyne@latest
      
      - name: Extract version from tag
        id: extract_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "COMMIT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV
      
      - name: Build with fyne
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          fyne package -os windows -icon icon.png -appID com.rashidpathiyil.attendancetracker \
            -release -name "Attendance Tracker" -appVersion "$VERSION" -appBuild "$COMMIT_SHA"
          # Compress with UPX
          upx --best "Attendance Tracker.exe" || true
      
      - name: Create release directory
        run: |
          mkdir -p ./release
          cp "Attendance Tracker.exe" ./release/
          cp LICENSE ./release/ || true
          cp README.md ./release/ || true
          cp -r assets ./release/ || true
      
      - name: Generate checksums
        run: |
          cd ./release
          sha256sum "Attendance Tracker.exe" > "Attendance Tracker.exe.sha256"
          cd ..
      
      - name: Create ZIP archive
        run: |
          cd ./release
          zip -r "../Attendance-Tracker-${{ env.VERSION }}-windows.zip" .
          cd ..
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Attendance-Tracker-${{ env.VERSION }}-windows.zip
          name: Attendance Tracker ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: attendance-tracker-${{ env.VERSION }}
          path: ./release/ 
